#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const projectRoot = path.resolve(__dirname, '..');
const dataRoot = path.join(projectRoot, 'data', 'capacity');
const outFile = path.join(projectRoot, 'constants', 'capacity-data.ts');

const DATASETS = {
  CREC: [
    'data/capacity/CREC/Copy of CREC Fall 2023.csv',
    'data/capacity/CREC/Copy of CREC Spring 2024.csv',
    'data/capacity/CREC/Copy of CREC Summer 2024.csv',
    'data/capacity/CREC/Copy of Fall 2024 CREC.csv',
  ],
  RWC: [
    'data/capacity/RWC/RWC Fall 2023.csv',
    'data/capacity/RWC/RWC Spring 2024.csv',
    'data/capacity/RWC/RWC Summer 2024.csv',
  ],
};

function parseStartMinutes(label) {
  const m = label.match(/^(\d{2}):(\d{2})(am|pm)\s-\s/i);
  if (!m) return Number.MAX_SAFE_INTEGER;
  let hour = Number(m[1]) % 12;
  const minute = Number(m[2]);
  const suffix = m[3].toLowerCase();
  if (suffix === 'pm') hour += 12;
  return hour * 60 + minute;
}

function parseCsvRows(raw) {
  const lines = raw.split(/\r?\n/).filter((line) => line.trim().length > 0);
  const headerIdx = lines.findIndex((line) => line.startsWith('Time Of Day,'));
  if (headerIdx < 0) return [];

  const rows = [];
  for (let i = headerIdx + 1; i < lines.length; i += 1) {
    const parts = lines[i].split(',');
    if (parts.length < 9) continue;
    const timeOfDay = parts[0].trim();
    if (!/^\d{2}:\d{2}(am|pm)\s-\s/i.test(timeOfDay)) continue;
    const total = Number(parts[8]);
    if (!Number.isFinite(total)) continue;
    rows.push({ timeOfDay, total });
  }
  return rows;
}

function buildProfile(sourceFiles) {
  const sumsByTime = new Map();

  sourceFiles.forEach((relPath) => {
    const absPath = path.join(projectRoot, relPath);
    const raw = fs.readFileSync(absPath, 'utf8');
    const rows = parseCsvRows(raw);

    rows.forEach(({ timeOfDay, total }) => {
      sumsByTime.set(timeOfDay, (sumsByTime.get(timeOfDay) || 0) + total);
    });
  });

  const entries = Array.from(sumsByTime.entries()).sort(
    (a, b) => parseStartMinutes(a[0]) - parseStartMinutes(b[0])
  );

  const labels = entries.map(([label]) => label);
  const totals = entries.map(([, total]) => total);
  const maxTotal = Math.max(...totals, 1);
  const distribution = totals.map((value) => Math.round((value / maxTotal) * 100));

  return { labels, distribution };
}

const output = {
  CREC: {
    sourceFiles: DATASETS.CREC,
    ...buildProfile(DATASETS.CREC),
  },
  RWC: {
    sourceFiles: DATASETS.RWC,
    ...buildProfile(DATASETS.RWC),
  },
};

const banner = [
  '// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.',
  '// Generated by: node scripts/generate-capacity-data.js',
  '',
].join('\n');

const ts = `${banner}export type CapacityDatasetProfile = {\n  sourceFiles: string[];\n  labels: string[];\n  distribution: number[];\n};\n\nexport const CAPACITY_DATASETS: Record<'CREC' | 'RWC', CapacityDatasetProfile> = ${JSON.stringify(output, null, 2)};\n`;

fs.writeFileSync(outFile, ts, 'utf8');
console.log(`Wrote ${path.relative(projectRoot, outFile)}`);
